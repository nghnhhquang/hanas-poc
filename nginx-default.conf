#/etc/nginx/conf.d/default.conf
#keepalive_timeout     3000;
#resolver_timeout      60s;
#proxy_connect_timeout 120s;
#proxy_send_timeout    120s;
#proxy_read_timeout    120s;
#gzip                  on;

client_body_buffer_size     32k;
#client_header_buffer_size   8k;
#large_client_header_buffers 8 64k;

#real_ip_header X-Real-IP;
#real_ip_recursive on;
#access_log /var/log/nginx/fallback_access.log proxy;
#error_log /var/log/nginx/fallback_error.log warn;

#sendfile                      on;
#server_tokens                 off;
#tcp_nopush                    on;
#tcp_nodelay                   on;
#client_max_body_size          2000m;
#server_names_hash_bucket_size 1024;
#ssl_prefer_server_ciphers     on;

#proxy_http_version            1.1;
#proxy_set_header Upgrade      $http_upgrade;
#proxy_set_header Connection   $http_connection;

#proxy_set_header              Accept-Encoding "";
#proxy_cache                   off;
#proxy_cache_path              /var/lib/nginx/cache/public  levels=1:2 keys_zone=public-cache:30m max_size=192m;
#proxy_cache_path              /var/lib/nginx/cache/private levels=1:2 keys_zone=private-cache:5m max_size=1024m;

#proxy_set_header  X-Real-IP $remote_addr;

#portal
server {
  listen 8080;

  #server_name localhost;
  #access_log  /var/log/nginx/host18880.access.log main;
  #error_log   /var/log/nginx/host18880.error.log warn;

  proxy_set_header  Host $host:$server_port;
  proxy_set_header  X-ProxyScheme $scheme;
  proxy_set_header  X-ProxyHost $host;
  proxy_set_header  X-ProxyPort $server_port;
  proxy_set_header  X-Forwarded-Scheme $scheme;
  proxy_set_header  X-Forwarded-Proto $scheme;
  proxy_set_header  X-Forwarded-For $proxy_add_x_forwarded_for;
  proxy_set_header  X-Real-IP $remote_addr;

  proxy_hide_header X-Frame-Options;
  proxy_hide_header Content-Security-Policy;
  add_header        Content-Security-Policy "frame-ancestors http://${host}:* http://*.hanas.io";

  location / {
    proxy_pass http://gateway:5500;
  }
}
#vault
server {
  listen 443 ssl;
  server_name vault.hanas.io;
  ssl_certificate /etc/nginx/certs/star-hanas-io.crt;
  ssl_certificate_key /etc/nginx/certs/star-hanas-io.key;

  proxy_set_header Host $host;
  proxy_set_header  X-ProxyScheme $scheme;
  proxy_set_header  X-ProxyHost $host;
  proxy_set_header  X-ProxyPort $server_port;
  proxy_set_header  X-Forwarded-Scheme $scheme;
  proxy_set_header  X-Forwarded-Proto $scheme;
  proxy_set_header  X-Forwarded-For $proxy_add_x_forwarded_for;
  proxy_set_header  X-Real-IP $remote_addr;
  
  location / {   
    proxy_pass http://vault:8200;
  }
}
#confluent
server {
  listen 9021;

  proxy_set_header  Host $host:$server_port;
  proxy_set_header  X-ProxyScheme $scheme;
  proxy_set_header  X-ProxyHost $host;
  proxy_set_header  X-ProxyPort $server_port;
  proxy_set_header  X-Forwarded-Scheme $scheme;
  proxy_set_header  X-Forwarded-Proto $scheme;
  proxy_set_header  X-Forwarded-For $proxy_add_x_forwarded_for;
  proxy_set_header  X-Real-IP $remote_addr;

  proxy_hide_header X-Frame-Options;
  proxy_hide_header Content-Security-Policy;
  add_header        Content-Security-Policy "frame-ancestors http://${host}:* http://*.hanas.io";

  location / {   
    proxy_pass http://confluent:9021;
  }
  location /portal/ {   
    proxy_pass http://gateway:5500/portal/;
  }
}
#datahub
server {
  listen 9002;

  proxy_set_header  Host $host:$server_port;
  proxy_set_header  X-ProxyScheme $scheme;
  proxy_set_header  X-ProxyHost $host;
  proxy_set_header  X-ProxyPort $server_port;
  proxy_set_header  X-Forwarded-Scheme $scheme;
  proxy_set_header  X-Forwarded-Proto $scheme;
  proxy_set_header  X-Forwarded-For $proxy_add_x_forwarded_for;
  proxy_set_header  X-Real-IP $remote_addr;

  proxy_hide_header X-Frame-Options;
  proxy_hide_header Content-Security-Policy;
  add_header        Content-Security-Policy "frame-ancestors http://${host}:* http://*.hanas.io";

  location / {   
    proxy_pass http://datahub:29002;
  }
  location /assets/index-e3e3578b.css {
    proxy_pass http://gateway:5500/portal/styles/datahub-index-e3e3578b.css;
  }
  location /autovault/ {
    proxy_pass http://autovault:18000/;
  }
  location /dbtdocs/ {
    proxy_pass http://dataiku:11000/local/static/dbtdocs/;
  }
  location /erd/ {
    proxy_pass http://erd:13000/;
  }
  location /portal/ {   
    proxy_pass http://gateway:5500/portal/;
  }
}
#dataiku
server {
  listen 11000;

  proxy_set_header  Host $host:$server_port;
  proxy_set_header  X-ProxyScheme $scheme;
  proxy_set_header  X-ProxyHost $host;
  proxy_set_header  X-ProxyPort $server_port;
  proxy_set_header  X-Forwarded-Scheme $scheme;
  proxy_set_header  X-Forwarded-Proto $scheme;
  proxy_set_header  X-Forwarded-For $proxy_add_x_forwarded_for;
  proxy_set_header  X-Real-IP $remote_addr;

  proxy_hide_header X-Frame-Options;
  proxy_hide_header Content-Security-Policy;
  add_header        Content-Security-Policy "frame-ancestors http://${host}:* http://*.hanas.io";

  location / {   
    proxy_pass http://dataiku:11000;
  }
  location /portal/ {   
    proxy_pass http://gateway:5500/portal/;
  }
}
#workflow
server {
  listen 5001;

  access_log  /var/log/nginx/workflow.access.log main;
  error_log   /var/log/nginx/workflow.error.log warn;

  proxy_set_header  Host $host:$server_port;
  #proxy_set_header  X-ProxyScheme $scheme;
  #proxy_set_header  X-ProxyHost $host;
  #proxy_set_header  X-ProxyPort $server_port;
  #proxy_set_header  X-Forwarded-Scheme $scheme;
  #proxy_set_header  X-Forwarded-Proto $scheme;
  #proxy_set_header  X-Forwarded-For $proxy_add_x_forwarded_for;
  #proxy_set_header  X-Real-IP $remote_addr;

  #proxy_hide_header X-Frame-Options;
  #proxy_hide_header Content-Security-Policy;
  #add_header        Content-Security-Policy "frame-ancestors http://${host}:* http://*.hanas.io";

  location / {
    proxy_pass http://workflow:5001;
  }
  location /business-central/ {
    proxy_cookie_flags ~ nosecure;
    proxy_pass http://jbpm:5501/business-central/;
  }
  location /kie-server/ {
    proxy_pass http://jbpm:5501/kie-server/;
  }
  location /portal/ {   
    proxy_pass http://gateway:5500/portal/;
  }
}